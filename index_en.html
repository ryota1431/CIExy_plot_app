<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CIExy Chromaticity Diagram Plotter</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-vOtmwsgJvAciY4bn06edobhmE+Wz/DTnJ/ckhIDCsMqFeTLjMXMD1N+1S3yN79YqN9sYNeQCEieZomXh8jv7PA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/svg2pdf.js/0.3.3/svg2pdf.min.js" integrity="sha512-6QStPt4r1GYGLDnZ4Ku2YcSHdZeyRvZI4YtoOUSSVu9T8P/fww7Ko/8l1MavbVOheXG2oGtOHjJ0UkT1LxepPg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    /* Page-specific styles for CIExy App */
    .app-container {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      align-items: flex-start;
    }

    .form-card {
      flex: 1;
      min-width: 280px;
    }
    
    .chart-card {
      flex: 2;
      min-width: 320px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #cie-svg {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }

    /* Form styling */
    #plotForm {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    #plotForm label {
      font-weight: 600;
      color: #333;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    #plotForm input[type="number"],
    #plotForm input[type="text"],
    #plotForm input[type="color"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box; /* Important for padding and width */
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    #plotForm input[type="color"] {
      padding: 5px; /* Color input has different default padding */
      height: 45px;
    }

    #plotForm input:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
    }

    .form-buttons {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .form-buttons button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
    }

    .form-buttons button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    #plotBtn {
      background-color: #1a73e8;
      color: white;
    }
    #plotBtn:hover {
        background-color: #1868d1;
    }

    #downloadBtn {
      background-color: #f1f3f4;
      color: #3c4043;
      border: 1px solid #dadce0;
    }
    #downloadBtn:hover {
        background-color: #e8eaed;
    }

    @media (max-width: 850px) {
        .app-container {
            flex-direction: column;
        }
        .form-card {
            max-width: 100%;
        }
    }
  </style>
</head>
<body>
  <header>
    <h1>CIExy Chromaticity Diagram Plotter</h1>
    <a href="./index.html" style="position: absolute; top: 20px; right: 20px;">日本語</a>
  </header>
  <main>
    <div class="app-container">
      <div class="card form-card">
        <h2>Plot Settings</h2>
        <form id="plotForm">
          <label>
            Bulk data input (x, y, color, label, radius, shadow ON/OFF)
            <textarea id="bulk" rows="6" placeholder="e.g.&#10;0.33,0.33,#ff0000,Red,8,ON&#10;0.6,0.3,#0000ff,Blue,5,OFF">0.30,0.33,#ffffff,White point,5,ON&#10;0.15,0.10,#0000ff,Blue point,5,OFF</textarea>
          </label>
          <div class="form-buttons">
            <button type="submit" id="plotBtn">Plot</button>
            <button type="button" id="downloadBtn">Download PDF</button>
            <button type="button" id="downloadBtnPpt">Download SVG (for PowerPoint)</button>
          </div>
        </form>
      </div>
      <div class="card chart-card">
        <svg id="cie-svg" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
          viewBox="0 0 500 530">
          <defs>
            <path id="border"
              d="M150,473C147,473 145,471 142,469C135,462 129,455 124,446C121,441 118,436 116,431C113,424 110,416 107,408C103,396 99,385 95,373C86,339 77,298 72,264C66,226 61,179 62,141C63,118 65,81 80,60C84,54 91,50 98,49C105,48 112,51 118,53C140,60 160,76 178,90C236,135 287,191 339,243C360,264 380,284 401,305C409,313 417,321 426,329C428,332 430,334 433,337C434,337 434,338 435,339C435,339 436,340 436,340" />
              <filter id="dot-shadow" x="-30%" y="-30%" width="160%" height="160%">
              <feDropShadow dx="2" dy="2" stdDeviation="2" flood-color="#333" flood-opacity="0.4"/>
            </filter>
          </defs>
          <clipPath id="clipborder">
            <use xlink:href="#border" />
          </clipPath>
          <use stroke="black" stroke-width="4" fill="none" xlink:href="#border" />
          <g clip-path="url(#clipborder)">
            <filter id="blur">
              <feGaussianBlur stdDeviation="0.5" />
            </filter>
            <image width="27" height="28" filter="url(#blur)"
              xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAcCAIAAAAfs1O6AAAAAXNSR0IArs4c6QAAA7tJREFUeF591cuKHFUYwPH/d+rUpaenZ5JMLkaMuBAJQly5EeJCtz6M+AC+khvxIbIw4AVMAsEQJ5kkM+mpnumu7rqdz65zOHQxgvCnqCqoX38f1XQL+gsALTRQwwYquIRzOIHH3/HkM/gQbsF1uKbMlKljryfvyDpsS9JgtrVIi0UNgCQwzsYywMS7KVhIdci6oaTDxCSIkACgEbpSGkV/raShwPVe9FCIJn48muB1346LM4aLUBwwcF40DdKAP5r4cETHXBSTEZ/5AdMe25F4a8SNZ8T+t6uikoXCgHE0qaEOxyjuUB0vl43FFPJtSu5I4/s1NSZyxBODBiimV7ic8MqjmPVerDEbZAOjYzgJECgIoODAoxEhDlgohSNvd5ysI9dAqMWgCTpeOUOj5Z0jHuYcTpRtRUdaY9eYakgqqAaXyrceMuNliSv7im0Zk5t8co2vpnw67Ska0jVmNcQSWQ2xrdqhCT9+DwZklwiAOGge4h6Qf0xx1x3caPYmyxO7wFx6bumttW/jq2EziD9E0SAmnCOAIt3XmPtbUfM7XX6wKrJylsyPWSAXEMTqKmpxFkAUHDpGFeoPSI6or7v9WV1kl2JKlUXC+Z8sy0Gpfa2vC4UXAqh6IkEckgwZ8wC9w+wmzfV2NblMkrKVsqHsKYXF31THnov1Xuyx9BaIa/pIMT2afm7y2/RHrp1VF+l5I/OVzNect5z3LISLnNVz2gDtilsDeBS8C+I+Qm+i19omnztzNpWzKfN93teUHaWjhDJl/gTHOEtnxyAICio4ua1y4HRSrZN3Be9yTgvOJsy3bsu840x5Ba9n0EdPwVm6BAiKvyP0hla+rc2Bo2jVLFveWN5kbN3TCWcbThtetTwXmELnC2jvxdaAh0KdUAuV3Ktkr8XWjguj7ywnGW+35RwX/NGA8VzrC2IXxSbxInQ7jnO5sSKvMRWUom8TfW35J5VHGW4K5r9fnCj2diCAXmiFmoFbyL0TZhuyFeYSPYVjw++WNwXsg0ACqa8NXRENQMtAr+FCOOX+a/ZW2BI5hWeiT42SCYXSCRpQXwM20MTFDWuGKmEJC+E9vOTWS4pn2F/V/AxPcSRKqmThNxeK/8myFoANrIQS3sJfHL6geEwBFgUUo7tNs/hFAST+URroIPFbV16s4IIw4Bc/cQsOIQcTn1QS9QsKveIEBUaoQBK3rhi6JAzIb3wJRzCFDDUAKEIYE+tLNc7rS8MxZFkCccAXfPOIuzCDHLVxRkXUbxdQoSdOSlwiZv4FiZsWgB+yll0AAAAASUVORK5CYII="
              transform="translate(36,35.8) scale(16)"> </image>
          </g>
          <path stroke="black" stroke-width="2" stroke-linecap="square" fill="none"
            d="M60,15l0,461l410,0M60,476l0,4M86,476l0,4M111,476l0,4M137,476l0,4M162,476l0,4M188,476l0,4M214,476l0,4M239,476l0,4M265,476l0,4M290,476l0,4M316,476l0,4M342,476l0,4M367,476l0,4M393,476l0,4M418,476l0,4M444,476l0,4M470,476l0,4M60,476l-4,0M60,450l-4,0M60,425l-4,0M60,399l-4,0M60,373l-4,0M60,348l-4,0M60,322l-4,0M60,297l-4,0M60,271l-4,0M60,245l-4,0M60,220l-4,0M60,194l-4,0M60,169l-4,0M60,143l-4,0M60,117l-4,0M60,92l-4,0M60,66l-4,0M60,41l-4,0M60,15l-4,0" />
          <g font-family="Nimbus Roman No9 L, Times, serif" font-size="19" stroke="none">
            <g fill="black">
              <g text-anchor="middle">
                <text x="264.8" y="515.8" font-style="italic">x</text>
                <text x="60" y="495.8">0.0</text>
                <text x="111.2" y="495.8">0.1</text>
                <text x="162.4" y="495.8">0.2</text>
                <text x="213.6" y="495.8">0.3</text>
                <text x="264.8" y="495.8">0.4</text>
                <text x="316" y="495.8">0.5</text>
                <text x="367.2" y="495.8">0.6</text>
                <text x="418.4" y="495.8">0.7</text>
                <text x="469.6" y="495.8">0.8</text>
              </g>
              <g text-anchor="end">
                <text x="20" y="251.4" font-style="italic">y</text>
                <text x="52" y="481.8">0.0</text>
                <text x="52" y="430.6">0.1</text>
                <text x="52" y="379.4">0.2</text>
                <text x="52" y="328.2">0.3</text>
                <text x="52" y="277">0.4</text>
                <text x="52" y="225.8">0.5</text>
                <text x="52" y="174.6">0.6</text>
                <text x="52" y="123.4">0.7</text>
                <text x="52" y="72.2">0.8</text>
                <text x="52" y="21">0.9</text>
              </g>
            </g>
          </g>
          <!--Origin(0.0, 0.0) = (60, 476)-->
          <!--(0.8, 0.0) = (470, 476)-->
          <!--(0.0, 0.9) = (60, 16)-->
          <g id="plot-group"></g>
        </svg>
      </div>
    </div>
  </main>
  <footer>
    &copy; 2025 Ryota Tazawa
  </footer>
  <script>
    // SVG coordinate transformation
    function xyToSvg(x, y) {
      // Match the transformation formula in SVG
      // px = 60 + x * 410 / 0.8
      // py = 476 - y * 460 / 0.9
      const px = 60 + x * 410 / 0.8;
      const py = 476 - y * 460 / 0.9;
      return {px, py};
    }

    // ...既存のコード...
document.getElementById('plotForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const g = document.getElementById('plot-group');
  const bulk = document.getElementById('bulk').value.trim();


  // 複数データ入力
  const lines = bulk.split('\n');
  lines.forEach(line => {
    if (!line.trim()) return;
    // カンマ区切りで分割してスペースを削除
    const [x, y, color, label, radius, shadow] = line.split(',').map(item => item.trim());
    const {px, py} = xyToSvg(parseFloat(x), parseFloat(y));
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    if (shadow) {
        const shadowCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        shadowCircle.setAttribute('cx', px + 1);
        shadowCircle.setAttribute('cy', py + 1);
        shadowCircle.setAttribute('r', radius);
        shadowCircle.setAttribute('fill', 'black');
        shadowCircle.setAttribute('fill-opacity', '0.4');
        g.appendChild(shadowCircle);
      }
    circle.setAttribute('cx', px);
    circle.setAttribute('cy', py);
    circle.setAttribute('r', radius ? parseFloat(radius) : 5);
    circle.setAttribute('fill', color || '#ffffff');
    g.appendChild(circle);

    if (label) {
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('x', px + 8);
      text.setAttribute('y', py - 8);
      text.setAttribute('font-size', 16);
      text.setAttribute('fill', color || '#ffffff');
      text.setAttribute('stroke', 'black');
      text.setAttribute('stroke-width', '0.5');
      text.setAttribute('paint-order', 'stroke');
      text.textContent = label;
      if (shadow == 'ON') {
      text.setAttribute('filter', 'url(#dot-shadow)');
    }
      g.appendChild(text);
    }
  });
  
});

    // PDF download function
    document.getElementById('downloadBtn').addEventListener('click', async function() {
      const svgNode = document.getElementById('cie-svg');
      const svgClone = svgNode.cloneNode(true);
      svgClone.setAttribute("xmlns", "http://www.w3.org/2000/svg");
      svgClone.setAttribute("xmlns:xlink", "http://www.w3.org/1999/xlink");

      const viewBox = svgNode.viewBox.baseVal || {width: svgNode.clientWidth, height: svgNode.clientHeight};
      const width = viewBox && viewBox.width ? viewBox.width : svgNode.getBoundingClientRect().width;
      const height = viewBox && viewBox.height ? viewBox.height : svgNode.getBoundingClientRect().height;
      const orientation = width >= height ? 'landscape' : 'portrait';

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation,
        unit: 'pt',
        format: [width, height]
      });

      await Promise.resolve(window.svg2pdf(svgClone, pdf, {
        x: 0,
        y: 0,
        width,
        height
      }));

      pdf.save('ciexy_plot.pdf');
    });

    // SVG download function for PowerPoint
    document.getElementById('downloadBtnPpt').addEventListener('click', function() {
      const svgNode = document.getElementById('cie-svg');
      const svgClone = svgNode.cloneNode(true);
      // Remove shadows (filters) for better compatibility
      svgClone.querySelectorAll('[filter]').forEach(el => el.removeAttribute('filter'));
      svgClone.setAttribute("xmlns", "http://www.w3.org/2000/svg");
      svgClone.setAttribute("xmlns:xlink", "http://www.w3.org/1999/xlink");
      const serializer = new XMLSerializer();
      const source = serializer.serializeToString(svgClone);
      const blob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ciexy_plot_for_ppt.svg";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
